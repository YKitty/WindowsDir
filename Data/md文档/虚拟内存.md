# 虚拟内存

---

## 概念

主存：线性连续的字节数组

程序计数器(PC)：程序计数器本质上就是一个字大小的寄存器。字：4字节(32位机)，8字节(64位机)。一般存放的都是要执行的下一条指令的地址

寄存器文件：是由一些单个字长的寄存器组成，每个寄存器都有唯一的名字。本质上是一个小的存储设备

## 虚拟内存的三个好处

- 他将主存看成一个存储在磁盘上的地址空间的高速缓存，在主存中只保存活动区域，并根据需要在磁盘和主存之间来回传送数据，通过这种方式高效的使用了主存
- 他为每一个进程提供了一致的地址空间，从而简化了内存管理
- 他保护了每个进程的地址空间不被其他的进程破坏

## 1. 物理和虚拟寻址

计算机系统的主存被组织成一个由M个连续的字节大小的单元组成的数组。每个字节都有一个唯一的物理地址。

第一个字节是0，第二个是1，依次类推。给定这种简单的结构，CPU访问内存的最自然的方式就是使用物理地址。这就是**物理寻址**

举例：对于一条加载指令，读取从物理地址4处开始的4字节字。当CPU执行这条加载指令的时候，生成一个有效的物理地址，通过地址内存总线，把他传递给主存。主存从物理地址为4处取出4字节，然后通过内存总线将其返回给CPU，CPU会将其放在一个寄存器文件。

现代处理器使用的是**虚拟寻址：**

使用虚拟寻址，CPU通过生成一个虚拟地址来访问主存，这个虚拟地址在被传送到主存之前会被转化成适当的物理地址。将一个虚拟地址转化为物理地址的任务叫做地址翻译。

就像异常处理一样，地址翻译需要**CPU硬件和操作系统**之间的紧密合作。CPU芯片上叫做**内存管理单元的专用硬件，利用存放在主存中的查询表来动态翻译虚拟地址，该表的内容由操作系统管理。**

## 2. 地址空间

地址空间是一个**非负整数地址的有序集合。**

一个地址空间的大小是由表示最大地址所需要的位数来描述的。例如：一个包含了N=2^n个地址的虚拟地址空间就叫做一个n为地址空间。现代系统通常支持**32位或者64位虚拟地址空间。**

一个系统还有一个物理地址空间，对应于物理内存的M个字节。

地址空间是很重要的。因为他清楚区分了数据对象(字节)和他们的属性(地址)。**允许每个数据对象有多个独立的地址。其中每个地址都选自一个不同的地址空间**。这就是虚拟内存的基本思想。

**主存中的每字节都有一个选自虚拟地址空间的虚拟地址和一个选自物理地址空间的物理地址。**

## 3. 虚拟内存

虚拟内存被组织为一个存放在**磁盘**上的N个连续的字节大小的单元组成的**数组**。每字节都有一个唯一的虚拟内存，作为到数组的索引。磁盘上数组的内容被缓存在主存中。

磁盘上的数据被分割成块，这些块作为磁盘和主存之间的传输单元。虚拟内存将数据分割成虚拟页的大小的固定块来进行数据传输。

在任何时刻，虚拟页都被分成三部分：

- 未分配的。对于虚拟内存上还没有进行数据，也就是磁盘上还不存在。
- 已缓存的。在虚拟内存上已经有数据了，并且数据也被映射到了物理内存上
- 未缓存的。在虚拟内存上已经有数据，但是数据没有被映射到物理内存上

### 1. 页表

同任何缓存一样，虚拟内存系统必须有某种方法来判定一个虚拟页是否缓存在DRAM(物理内存)中的某个地方。如果是，系统还必须确定这个虚拟页存放在那一个物理页中。如果不命中，系统必须判断这个虚拟页表存放在磁盘的那个位置，在物理内存中选择一个牺牲页，并将虚拟内存页从磁盘复制到DRAM中，替换这个牺牲页。

这些功能是由软硬件联合提供的，包括操作系统软件，MMU(内存管理单元)中的地址翻译硬件以及一个存放在物理内存中叫做页表的数据结构。

页表将虚拟页映射到物理页，每次地址翻译硬件将一个虚拟地址转化为物理地址，都会读取页表。操作系统负责维护页表的内容，以及在磁盘和DRAM之间来回传送页。

页表就是一个页表条目的数组。